name: C/C++ CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build_test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Build
      run: |
        pwd
        mkdir build
        cd build
        cmake ..
        make -j$(nproc)
    - name: Test
      run: |
        pwd
        cd build
        ./csrc/benchmark 300 400 500
        TEST_RESULT=$(cat << EOF
        $(cat speed_test.md)
        EOF
        )
        echo "TEST_RESULT<<EOF" >> $GITHUB_ENV
        echo "$TEST_RESULT" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
      id: speed_test
    - name: Comment PR
      uses: thollander/actions-comment-pull-request@v1
      with:
        message: |
          ${{ env.TEST_RESULT }}
        pr_number: 1
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
